name: Build & Deploy
on:
  push:
    branches: [main]

jobs:
  deploy_bot:
    runs-on: ubuntu-latest
    steps:
      - name: Connect to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          key: ${{ secrets.SSH_KEY }}
          username: ${{ secrets.SSH_USER }}

      - name: Configure directory
        run: |
          WORKING_DIR="skele-ci"
          REPO="skele"
          mkdir -p $WORKING_DIR
          cd $WORKING_DIR

          if [ ! -d $REPO ]; then
            echo "working directory is empty, cloning skele..."
            git clone git@github.com:jaronaearle/skele.git
            cd $REPO
          else
            echo "repo exists, pulling latest changes..."
            cd $REPO
            git pull
          fi

          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" > .env
          echo "HONEY_BADGER_API_KEY=${{ secrets.HONEY_BADGER_API_KEY }}" >> .env

      - name: Stop previously deployed container
        run: |
          docker kill $(docker ps -q)

      - name: Build bot binary
        run: |
          if [ ! -f .env ]; then
            exit 1
          else 
            task docker-build
          fi

      - name: Execute bot binary
        run: |
          if [[ -d bin  &&  -f bin/skele ]]; then
            echo "bin is dir and skele in bin"
            task docker-bot
          else
            exit 1
          fi
