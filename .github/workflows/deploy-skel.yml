name: Build & Deploy
on:
  push:
    branches: [main]

jobs:
  deploy_bot:
    runs-on: ubuntu-latest
    steps:
      - name: Configure working directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          key: ${{ secrets.SSH_KEY }}
          username: ${{ secrets.SSH_USER }}

          script: |
            WORKING_DIR="skele-ci"
            REPO="skele"
            mkdir -p $WORKING_DIR
            cd $WORKING_DIR

            if [ ! -d $REPO ]; then
              echo "working directory is empty, cloning skele..."
              # git clone git@github.com:jaronaearle/skele.git
              cd $REPO

            else
              echo "repo exists, pulling latest changes..."
              cd $REPO
              git pull
            fi

            echo ${{ secrets.BOT_TOKEN }} > .env
            echo ${{ secrets.HONEY_BADGER_API_KEY }} >> .env
            cat .env

            # time to build -- need to find and kill other docker bot processes running

            task docker-build
            echo "bot built"
            task docker-bot
            echo "bot container running..."

            # persist docker docker process to server?
            docker ps
            sleep 10
            docker logs $(docker ps -ql)
            docker ps
